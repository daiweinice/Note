## 分布式架构的概念

### 一、传统项目的架构

#### 1. 特点:

+ all in one(所有模块在一起，技术也不分层)，
+ servlet(jsp)



#### 2. 缺点：

+ 并发量差容错性差(不具有高可用性)
+ 容错性差(不具有高可用性)

**注:** 不具有高可用性的意思是，比如当用户访问时，服务器后台因为一些原因导致服务器崩溃，用户就能直接看到错误页面，服务器也因为错误从而停止运行(宕机)，这就叫做不具有高可用性。



#### 3. 解决方案：

![img](images\MVC架构)

### 二、集群架构

![img](images\集群架构)

#### 1. 特点：

+ 项目采用多台服务器集群部署
+ mysql数据库采用多台服务器集群部署



#### 2. 优势：

+ 并发量提高(1000+)

+ 容错性提高(具有高可用性)

**注:** 一般的it公司，基本都是采用集群架构，因为这种架构方式已经基本能满足需求了，但是一些大型项目，这种方式就显然是力不从心了，只能采用分布式的架构方式



#### 3. 问题分析

通过上图我们发现这种集群部署存在两个问题

- session如何共享？
- 选择哪个作为解释请求的服务器呢？



#### 4. session如何共享?

我们都知道，session是会话，即一个用户访问服务器的时候，就会产生一个session，这个session会一致伴随着这个用户的访问全程，直到用户关闭浏览器结束这次会话，那么问题来了，问，挖掘技术哪家强？咳咳，错了，是如果用户访问服务器时，这台服务器挂掉了(宕机)，那么原先保存在这台服务器上的session也肯定挂掉了，那么就会产生一个后果，就是这个用户原本访问好好的，现在突然session没有了，而session没有了就意味着需要用户重新登陆才能进行一些相应操作，这显然是不行的，这样的服务用户体验实在太差了，根本不能满足互联网行业的用户需求，那么这就涉及到一个session共享的问题，即怎么把原有的session从一台服务器转移到另一台服务器上，但是怎么解决呢？有多种方案，常用的两种是：

##### (1) Tomcat共享session
用Tomcat集群复制(广播模式)来共享session. 这种解决方案是利用Tomcat来进行集群复制，把每个服务器上的session都共享式的都复制一遍，保证每个服务器上都有着一个用户的session数据.

**弊端:** 在传统项目中一般这么应用，因为传统项目的用户量少，可以承担压力，但当到互联网项目时，这种方式就绝对不可取了，打个比方，比如用户量有100万，那么就需要在每个服务器上都复制这100万个用户的session，这样做显然会极大的消耗系统资源，使系统变得极为臃肿和不稳的，所以在互联网项目里是绝对不会采用这种方式的

##### (2) redis存储session

用第三方redis服务器来存储session

用这种方式来存储session的话，只需当前正在使用的项目把所有session都放在redis里面，当有其他项目需要使用时，就可以直接从redis中直接获取session，从而解决了这个问题

如图：



![img](images\redis存储session)

**怎么解决选择哪个作为解释请求的服务器呢？**

用nginx服务器来分发请求，实现负载均衡。

![img](images\Nginx实现负载均衡)

这种架构的并发量是多少呢？大概是1000+左右，如果服务器更多的话，能达到1000以上，一万以下，但是这能满足互联网的极致要求呢？答案当然是不能了，虽说也可以不断的扩展服务器，但是对于公司的成本和维护成本来说，无疑会达到一个非常高昂的消耗，比如说一台最便宜的服务器的价格大概是3到5万，假如要抵御一万的并发，每台服务器能支持200的并发率，那么需要多少台服务器？50台！这还仅是单击版的，还构建集群呢？比如说构建3台服务器，3*50=150台，服务器构建完了，数据库呢？数据库也需要构建集群呀！这就又是好几百台，这么一算下来大概的费用就是好几百万了，这仅仅是配置的费用，还没有计算维护的成本呢？比如说我们都知道服务器对于机房的要求是非常苛刻的，比如恒温，无尘等等(题外话：阿里之所以把云计算基地定在杭州就是看中了那里气温稳定，适合布置服务器集群)。这样一来又需要布置大型的机房，综合以上所述，虽说集群能后解决部分问题，但并不能解决所有问题，无论是从公司成本还是运营成本来说，显然这种传统的集群架构是不适应现在的互联网行业的，而且对于一般的公司来说也不可能去花大价钱做这种布置。所以，这种情况下我们就必须对我们的架构来进行优化了，那么如何在服务器只有一定数量的情况下，让我们的项目的成本能达到一定控制，并且让我们的项目达到一个最优化的并发的访问量呢？那么就需要对现有的这种架构进行再次拆分，让我们的项目成为面向服务的分布式架构。



### 三、面向服务的分布式架构(SOA)



![img](images\分布式架构)



#### 1. 基础分布式架构存在的问题

如图所示，第一种方式还是有着明显的缺点的，如服务层的网路抖动或是服务层进程繁忙

**网络抖动**：当有大量用户访问时，可能会出现service层的延迟现象，而web层因为长期得不到响应，则会抛出时间超出异常

**进程繁忙**：这个的意思和前边的差不多，都是指service层业务太多，顾不上web层的请求，web层的请求就只能一直在那等着，时间长了也就抛出超时异常了



#### 2. 服务治理中间件dubbo

![img](images\消息中间件改善分布式架构)**注:** 注意是服务治理中间件, 与消息中间件是不同的类型



**RPC框架:**

RPC（Remote Procedure Call Protocol）**远程过程调用**协议。一个通俗的描述是：客户端在不知道调用细节的情况下，调用存在于远程计算机上的某个对象和方法，就像调用本地应用程序中的对象和方法一样。比较正式的描述是：一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。 Dubbo就是一个RPC框架.



**为什么使用RPC进行进程通信而不直接使用HTTP?**

开始的无知，系统直接的交互使用http对接，觉得什么RPC分布式之间的调用不都是通过http吗，有种无知为什么要使用使用RPC，RPC是用来做什么的？

http使用没有任何问题，首先业务简单，系统之间的交互不是特别多的情况下是可以使用http 没有任何问题，

但是如果是一个大型的网站，内部子系统较多、接口非常多的情况下，RPC框架的好处就显示出来了，

+ 传输协议
    - RPC，可以基于TCP协议，也可以基于HTTP协议
    - HTTP，基于HTTP协议
+ 传输效率
    - RPC，使用自定义的TCP协议，可以让请求报文体积更小，或者使用HTTP2协议，也可以很好的减少报文的体积，提高传输效率
    - HTTP，如果是基于HTTP1.1的协议，请求中会包含很多无用的内容，如果是基于HTTP2.0，那么简单的封装以下是可以作为一个RPC来使用的，这时标准RPC框架更多的是服务治理
+ 性能消耗，主要在于序列化和反序列化的耗时
    - RPC，可以基于thrift实现高效的二进制传输
    - HTTP，大部分是通过json来实现的，字节大小和序列化耗时都比thrift要更消耗性能
+ 负载均衡
    - RPC，基本都自带了负载均衡策略
    - HTTP，需要配置Nginx，HAProxy来实现
+ 服务治理（下游服务新增，重启，下线时如何不影响上游调用者）
    - RPC，能做到自动通知，不影响上游
    - HTTP，需要事先通知，修改Nginx/HAProxy配置



**原理讲解:** 

看了第一种webservice的方法之后，我们采用了第二种方法，即dubbo这种中间件的方式. 

当服务器启动时service会把所有的对象通过dubbo注册给zookeeper，而以后每次需要请求获取对象时，就可以直接从dubbo中**异步**获取，不需要再去访问service层，这样就解决了服务层网络抖动和服务层进程繁忙的弊端。zookeeper可以看成是一个数据库，用来存储数据的。



#### 3、springcloud

这个软件是由外国开发，原理和dubbo差不太大。
Spring Cloud是一个基于Spring Boot实现的微服务架构开放工具。它为微服务架构中设计的配置管理、服务治理、断路器、智能路由、微代理、控制总线、全局锁、决策竞选、分布式会话和集群状态管理等操作提供了一种简单的开发方式。



### 四、总结

#### 1. 分布式框架的优点：

+ 大幅提高并发访问量(10000+)
+ 可以节省成本(因为这种优化仅是从架构方面进行优化，而不需要去配置大量的服务器)
+ 实现了服务层与表现层的解耦合



#### 2. 微服务架构

目前还有一种比分布式更火的架构模式，叫做微服务架构，它是通过服务的原子化拆分，以及微服务的独立打包、部署和升级，可以让小团队的交付周期将缩短，运维成本也将大幅度下降，可以预见，这种架构模式将会越来越受到广大企业的应用与喜爱。