## 一、消息中间件

### 1. 消息队列(MQ)

在高并发环境下，由于来不及同步处理，请求往往会发生堵塞，比如说，大量的insert，update之类的请求同时到达MySQL，直接导致无数的行锁表锁，甚至最后请求会堆积过多，从而触发连接错误。通过使用消息队列，我们可以异步处理请求，从而缓解系统的压力。

### 2. 消息中间件

消息中间件利用高效可靠的消息传递机制进行==平台无关==的数据交流，并基于数据通信来进行分布式系统的集成。通过提供消息传递和消息排队模型，它可以在分布式环境下扩展进程间的通信。对于消息中间件，常见的角色大致也就有Producer（生产者）、Consumer（消费者）

### 3. 消息中间键常见应用场景

#### (1) 异步处理

如用户注册功能, 注册后需向用户发送手机短信和电子邮件. 如果采用传统串行方式, 那么需要等待三个操作都完成后才能将结果返回给用户, 用户等待时间长.

因为发送短信和邮件并不是最核心的业务逻辑, 所以可以通过消息队列来进行异步处理, 这样用户的等待时间就只有注册信息写入数据库的时间和写入消息队列的时间(该时间极小).

#### (2) 解耦

如A系统发送数据给B、C、D三个系统, 通过接口调用发送. 后续如果需要增加更多的系统接收A系统的数据或者部分系统取消接收A的数据, 那么A系统就需要不断地修改.

这种情况下, A可以将数据发送到MQ中, 那个系统需要数据就去MQ中去取, 而不再需要A来发送. 这种消息中间件的发布订阅功能实现了系统的解耦.

#### (3) 削峰

如电商平台数据库在秒杀时期或购物高峰期每秒需要处理很多请求, 而在其他时间只有少量请求需要处理. 为了保证数据库服务器在高峰期不会挂掉, 可以使用消息中间件来存积请求, 数据库根据自身负载能力从消息中间件中获取请求并处理. 

这样虽然短时间内会有大量请求存积在消息中间件中, 但是可以保证服务器的稳定, 且在高峰期后, 请求变少, 服务器可以快速处理完存积在消息中间件中的请求.



## 二、RabbitMQ概述

### 1. RabbitMQ介绍

> RabbitMQ是实现了高级消息队列协议（AMQP）的开源消息代理软件（亦称面向消息的中间件）RabbitMQ服务器是用Erlang语言编写的，而群集和故障转移是构建在开放电信平台框架上的。所有主要的编程语言均有与代理接口通讯的客户端库。

### 2. RabbitMQ优点

+ 开源、性能优秀、稳定性保障
+ 提供可靠性消息投递模式(confirm)、返回模式(return)
+ 与SpringAMPQ完美整合, API丰富
+ 集群模式丰富、表达式配置、HA模式、镜像队列模型
+ 在保证数据不丢失的情况下做到高可靠性、高可用性

### 3. RabbitMQ高性能原因

RabbitMQ高性能的原因是因为它是用Erlang语言编写的.

Erlang语言最初在于交换机领域的架构模式, 它有着和原生Socket一样的延迟.

### 4. 高级消息队列协议(AMPQ)

#### (1) 概念

> AMPQ是具有现代特征的二进制协议. 是一个提供统一消息服务的应用层标准高级消息队列协议, 是应用层协议的一个开放标准, 为面向消息的中间件设计.

#### (2) AMPQ模型

![](images/AMPQ模型.png)

#### (3) AMPQ核心概念

+ **Server:** 又称Broker, 接收客户端的连接, 实现AMPQ实体服务
+ **Connection:** 连接, 应用程序与Broker的网络连接
+ **Channel:** 网络信道, 几乎所有的操作都在Channel中进行, Channel是进行消息读写的通道. 客户端可建立多个Channel, 每个Channel代表一个会话任务.
+ **Message:** 消息, 服务器和应用程序之间传送的数据. 由Properties和Body组成. Properties可以对消息进行修饰, 比如消息的优先级、延迟等高级特性; Body就是消息体内容.
+ **Virtual host:** 虚拟地址, 用于进行逻辑隔离, 最上层的消息路由. 一个Virtual host里可以由若干个Exchange和Queue, 同一个Virtual host里面不能有相同名称的Exchange或Queue
+ **Exchange:** 交换机, 接收消息, 根据路由键转发消息到绑定的队列
+ **Binding:** Exchange和Queue之间的虚拟连接, Binding中可以包含路由键(routing key)
+ **Routing key:** 一个路由规则, Virtual host可用它确定如何路由一个特定消息
+ **Queue:** 也成为Message Queue, 消息队列, 保存消息并将它们转发给消费者

#### (4) RabbitMQ架构图

![](images/RabbitMQ架构图.jpg)